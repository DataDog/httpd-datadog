variables:
  DOCKER_REGISTRY: registry.ddbuild.io
  CI_DOCKER_IMAGE_BASE: $DOCKER_REGISTRY/ci/httpd-datadog
  GIT_SUBMODULE_STRATEGY: recursive
  GIT_SUBMODULE_DEPTH: 1
  GIT_CONFIG_COUNT: 1
  GIT_CONFIG_KEY_0: url.https://gitlab-ci-token:${CI_JOB_TOKEN}@gitlab.ddbuild.io/DataDog/.insteadOf
  GIT_CONFIG_VALUE_0: https://github.com/DataDog/

stages:
  - ci-image
  - build
  - test

# Template jobs (hidden, reusable)
.build-template:
  stage: build
  image: $CI_DOCKER_IMAGE_BASE/$ARCH:$DOCKERFILE_HASH
  script:
    - git config --global --add safe.directory $PWD
    - >
      cmake --preset=ci-release
      -DHTTPD_DATADOG_ENABLE_RUM=ON
      -DCMAKE_TOOLCHAIN_FILE=/sysroot/${TOOLCHAIN_ARCH}-none-linux-musl/Toolchain.cmake
      -B build .
    - cmake --build build -j --verbose
    - cmake --install build --prefix dist
    - mkdir -p artifacts/$ARCH
    - cp dist/lib/mod_datadog.so artifacts/$ARCH/
    - cp dist/lib/mod_datadog.so.debug artifacts/$ARCH/ || true
  artifacts:
    paths:
      - artifacts/$ARCH/mod_datadog.so
      - artifacts/$ARCH/mod_datadog.so.debug

.test-rum-template:
  stage: test
  image: $CI_DOCKER_IMAGE_BASE/$ARCH:$DOCKERFILE_HASH
  script:
    - cd $CI_PROJECT_DIR/test/integration-test && uv sync && uv run pytest --module-path $CI_PROJECT_DIR/artifacts/$ARCH/mod_datadog.so --bin-path /httpd/httpd-build/bin/apachectl --log-dir $CI_PROJECT_DIR/logs -m requires_rum -v

build-ci-image:
  stage: ci-image
  allow_failure: true
  tags: ["arch:$ARCH"]
  image: $DOCKER_REGISTRY/docker:20.10.13
  parallel:
    matrix:
      - ARCH: amd64
        TOOLCHAIN_ARCH: x86_64
      - ARCH: arm64
        TOOLCHAIN_ARCH: aarch64
  script:
    - HASH=$(sha256sum .gitlab/Dockerfile | cut -d ' ' -f 1)
    - echo "DOCKERFILE_HASH=$HASH" >> docker.env
    - IMAGE_TAG="$CI_DOCKER_IMAGE_BASE/$ARCH:$HASH"
    - |
      if docker buildx imagetools inspect "$IMAGE_TAG" > /dev/null 2>&1; then
        echo "Image $IMAGE_TAG already exists. Skipping build."
        exit 0
      fi
    - >
      docker buildx build
      --tag $IMAGE_TAG
      --platform linux/$ARCH
      --build-arg ARCH=$TOOLCHAIN_ARCH
      --push
      --file .gitlab/Dockerfile
      .
  artifacts:
    reports:
      dotenv: docker.env

build:amd64:
  extends: .build-template
  needs:
    - job: "build-ci-image: [amd64, x86_64]"
  variables:
    ARCH: amd64
    TOOLCHAIN_ARCH: x86_64
  tags: ["arch:amd64"]

build:arm64:
  extends: .build-template
  needs:
    - job: "build-ci-image: [arm64, aarch64]"
  variables:
    ARCH: arm64
    TOOLCHAIN_ARCH: aarch64
  tags: ["arch:arm64"]

test-rum:amd64:
  extends: .test-rum-template
  needs:
    - job: "build-ci-image: [amd64, x86_64]"
    - job: "build:amd64"
  variables:
    ARCH: amd64
  tags: ["arch:amd64"]

test-rum:arm64:
  extends: .test-rum-template
  needs:
    - job: "build-ci-image: [arm64, aarch64]"
    - job: "build:arm64"
  variables:
    ARCH: arm64
  tags: ["arch:arm64"]
