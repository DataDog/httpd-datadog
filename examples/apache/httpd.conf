# Load mod_datadog module for enabling Datadog APM Traces for proxy
LoadModule datadog_module modules/mod_datadog.so

# Basic Apache configuration
ServerRoot "/usr/local/apache2"
Listen 80
Listen 81

# Modules
LoadModule mpm_event_module modules/mod_mpm_event.so
LoadModule authz_core_module modules/mod_authz_core.so
LoadModule dir_module modules/mod_dir.so
LoadModule mime_module modules/mod_mime.so
LoadModule rewrite_module modules/mod_rewrite.so
LoadModule proxy_module modules/mod_proxy.so
LoadModule proxy_http_module modules/mod_proxy_http.so
LoadModule status_module modules/mod_status.so
LoadModule log_config_module modules/mod_log_config.so
LoadModule setenvif_module modules/mod_setenvif.so

# Basic settings
ServerName localhost:80
DirectoryIndex index.html

# MIME types
TypesConfig conf/mime.types

# Log configuration with Datadog trace correlation
# ref. https://docs.datadoghq.com/integrations/apache/?tab=host#log-collection
LogFormat "%h %l %u %t \"%r\" %>s %b %D \"%{Referer}i\" \"%{User-Agent}i\" \"%{X-Forwarded-For}i\" dd.trace_id=\"%{datadog_trace_id}e\" dd.span_id=\"%{datadog_span_id}e\"" datadog_combined

# Keep original format as backup  
LogFormat "%h %l %u %t \"%r\" %>s %b %D \"%{Referer}i\" \"%{User-Agent}i\" \"%{X-Forwarded-For}i\"" combined

CustomLog "logs/access_log" datadog_combined
ErrorLog "logs/error_log"
LogLevel warn

# Security
<Directory />
    AllowOverride none
    Require all denied
</Directory>

# Document root
DocumentRoot "/usr/local/apache2/htdocs"
<Directory "/usr/local/apache2/htdocs">
    AllowOverride None
    Require all granted
</Directory>

# Main server - reverse proxy to API
<VirtualHost *:80>
    ServerName localhost
    
    # Enable proxy
    ProxyPreserveHost On
    ProxyPass / http://api:8080/
    ProxyPassReverse / http://api:8080/
    
    # Add headers for tracing
    ProxyPassReverse / http://api:8080/
    ProxyPreserveHost On
</VirtualHost>

# Extended status for more metrics
ExtendedStatus On

# Status server for Datadog monitoring
<VirtualHost *:81>
    ServerName _
    
    # Disable access logging for status endpoint
    CustomLog "logs/access_log" combined env=!dontlog
    SetEnvIf Request_URI "^/server-status" dontlog
    
    <Location "/server-status">
        SetHandler server-status
        Require all granted
    </Location>
</VirtualHost>